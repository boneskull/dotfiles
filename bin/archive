#!/bin/bash

doPack() {
  echo "Archiving npm module ${DIR}..."
  local NEWDIR="${BACKUP_DIR}/${DIR}"
  mv "${DIR}" "${BACKUP_DIR}"
  ${NPM} pack "${NEWDIR}"
  rm -frv "${NEWDIR}"
}

doArchive() {
  echo "Archiving ${DIR}..."
  local DATE=`slug "$(date '+%Y-%m-%d %H:%M:%S')"`
  gtar cvz --exclude-vcs -f "${BACKUP_DIR}/`slug ${DIR}`-${DATE}.tar.gz" ${DIR}
}

set -e

NPM=/usr/local/bin/npm
BACKUP_DIR="/media/samara/Archives/"
DIR="${1}"

type -p slug || {
  echo "You must 'npm install -g slug' first"
  exit 1
}

type -p gtar || {
  echo "You must 'brew install tar' first"
  exit 1
}

[[ ${DIR} ]] || {
  echo "Specify target directory"
  exit 1
}

[[ -d ${DIR} ]] || {
  echo "${DIR} must be a directory"
  exit 1
}

if [[ -e ${DIR}/package.json ]]
then
  doPack
else
  doArchive
fi
