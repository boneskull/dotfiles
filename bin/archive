#!/usr/bin/env zsh

set -Eeuo pipefail

# Load slugify from zshfunctions
fpath=(~/.dotfiles/zshfunctions $fpath)
autoload -Uz slugify

# We want gtar because tar on macOS doesn't support the --exclude-vcs-ignores option
if [[ "${OSTYPE}" == darwin* ]]; then
  (( ! $+commands[gtar] )) && {
    echo "tar not found, please execute 'brew install gnu-tar'"
    exit 1
  }
else
  TAR=${commands[tar]:-/usr/bin/tar}
fi

BACKUP_DIR="${HOME}/projects/archives"
DIR="${1}"

[[ ${DIR} ]] || {
  echo "Specify target directory"
  exit 1
}

[[ -d ${DIR} ]] || {
  echo "${DIR} must be a directory"
  exit 1
}

mkdir -p "${BACKUP_DIR}"

echo "Archiving ${DIR}..."
NOW=$(date '+%Y-%m-%d %H:%M:%S')
SLUGGED=$(slugify "$(basename ${DIR}) ${NOW}")

${TAR} cz --exclude-vcs-ignores --exclude-vcs -f "${BACKUP_DIR}/${SLUGGED}.tar.gz" "${DIR}"
rm -frv "${DIR}"
echo "Done"
